# ?? CH?C N?NG THANH TOÁN T? ??NG - HOÀN CH?NH

**Ngày t?o:** 2025-11-24  
**Tr?ng thái:** ? HOÀN THÀNH  
**Tính n?ng:** T? ??ng sinh hóa ??n khi khách hàng b?m mua

---

## ?? TÓNG QUAN

H? th?ng ?ã ???c b? sung ch?c n?ng **Checkout (Thanh Toán)** hoàn ch?nh v?i các tính n?ng:

? **T? ??ng t?o Invoice (Hóa ??n)** khi khách hàng b?m "Thanh Toán"  
? **T? ??ng t?o InvoiceDetails (Chi Ti?t Hóa ??n)** t? CartItems  
? **T? ??ng t?o Payment Record (B?n Ghi Thanh Toán)** v?i ph??ng th?c ?ã ch?n  
? **Hi?n th? ngày gi?** th?i gian th?c khi t?o ??n  
? **C?p nh?t t?n kho** s?n ph?m t? ??ng  
? **Xóa gi? hàng** sau khi ??t hàng thành công  
? **Transaction rollback** n?u có l?i

---

## ?? LU?NG HO?T ??NG

```
[1] Khách hàng vào Cart/Details
     ?
[2] Xem s?n ph?m trong gi? + Tóng ti?n
     ?
[3] B?m nút "Thanh Toán Ngay" ? Cart/Checkout
     ?
[4] Ch?n ph??ng th?c thanh toán (Cash/BankTransfer/CreditCard/MobilePayment)
     ?
[5] Nh?p ??a ch? giao hàng (optional)
     ?
[6] Nh?p ghi chú (optional)
     ?
[7] B?m "Xác Nh?n ??t Hàng"
     ?
[8] H? TH?NG T? ??NG:
     ?? T?o Invoice (mã t? ??ng: INV{timestamp}{random})
     ?? T?o InvoiceDetails t? CartItems
     ?? T?o Payment record (status: Pending)
     ?? C?p nh?t Stock (gi?m s? l??ng t?n kho)
     ?? Xóa Cart và CartItems
     ?? Commit transaction
     ?
[9] Chuy?n ??n Invoice/Details ? Hi?n th? hóa ??n v?a t?o
```

---

## ?? FILES ???C T?O/S?A

### 1. CartController.cs (?ã S?a)
**Path:** `QlyKhachHang/Controllers/CartController.cs`

**Thêm Actions:**
- `GET Checkout(int id)` - Trang thanh toán
- `POST ProcessCheckout(...)` - X? lý ??t hàng

**Thêm Helpers:**
- `GenerateInvoiceNumber()` - T?o mã hóa ??n t? ??ng
- `GetPaymentMethodText()` - Chuy?n ??i payment method text

### 2. Cart/Checkout.cshtml (M?i)
**Path:** `QlyKhachHang/Views/Cart/Checkout.cshtml`

**N?i dung:**
- Hi?n th? thông tin khách hàng
- Hi?n th? s?n ph?m trong gi?
- Form ch?n ph??ng th?c thanh toán
- Nh?p ??a ch? giao hàng
- Hi?n th? **ngày gi?** ??t hàng realtime
- Tóng tính t?ng ti?n + phí v?n chuy?n

### 3. Cart/Details.cshtml (M?i)
**Path:** `QlyKhachHang/Views/Cart/Details.cshtml`

**N?i dung:**
- Chi ti?t gi? hàng
- Thông tin khách hàng
- Danh sách s?n ph?m
- Tóm t?t ??n hàng
- Nút "Thanh Toán Ngay" (l?n, xanh, n?i b?t)

---

## ?? CHI TI?T K? THU?T

### A. T?o Invoice T? ??ng

```csharp
var invoice = new Invoice
{
    CustomerId = cart.CustomerId,
    InvoiceNumber = GenerateInvoiceNumber(),  // INV20251124143025_1234
    InvoiceDate = DateTime.Now,               // Ngày gi? hi?n t?i
    TotalAmount = totalAmount,                // Tóng ti?n
    PaidAmount = 0,                           // Ch?a thanh toán
    Status = "Pending",                       // Ch? xác nh?n
    Notes = notes,                            // Ghi chú t? form
    CreatedDate = DateTime.Now                // Th?i gian t?o
};

_context.Invoices.Add(invoice);
await _context.SaveChangesAsync();  // L?u ?? có InvoiceId
```

### B. T?o InvoiceDetails T? CartItems

```csharp
foreach (var cartItem in cart.CartItems)
{
    var invoiceDetail = new InvoiceDetail
    {
        InvoiceId = invoice.InvoiceId,
        ProductId = cartItem.ProductId,
        Quantity = cartItem.Quantity,
        UnitPrice = cartItem.UnitPrice
    };
    
    _context.InvoiceDetails.Add(invoiceDetail);
    
    // C?p nh?t t?n kho
    var product = await _context.Products.FindAsync(cartItem.ProductId);
    product.Stock -= cartItem.Quantity;
}
```

### C. T?o Payment Record

```csharp
var payment = new Payment
{
    InvoiceId = invoice.InvoiceId,
    Amount = 0,                              // Ch?a thanh toán
    PaymentMethod = paymentMethod,           // Cash/BankTransfer/etc
    Status = "Pending",                      // Ch? xác nh?n
    PaymentDate = DateTime.Now,              // Ngày t?o
    Notes = $"Ph??ng th?c: {GetPaymentMethodText(paymentMethod)}",
    CreatedDate = DateTime.Now
};

_context.Payments.Add(payment);
```

### D. Xóa Gi? Hàng

```csharp
// Xóa sau khi ??t hàng thành công
_context.CartItems.RemoveRange(cart.CartItems);
_context.Carts.Remove(cart);
```

### E. Transaction Safety

```csharp
using var transaction = await _context.Database.BeginTransactionAsync();

try
{
    // ... T?t c? các b??c trên
    
    await _context.SaveChangesAsync();
    await transaction.CommitAsync();  // Commit n?u thành công
}
catch (Exception ex)
{
    await transaction.RollbackAsync();  // Rollback n?u l?i
    _logger.LogError(ex, "Error processing checkout");
}
```

---

## ?? GIAO DI?N

### Cart/Details.cshtml

```
???????????????????????????????????????????????????????????
? Chi Ti?t Gi? Hàng #123              [Thanh Toán Ngay]  ?
???????????????????????????????????????????????????????????
? THÔNG TIN KH      ?  S?N PH?M TRONG GI?                 ?
?                   ?                                     ?
? Tên: Nguy?n A     ?  1. Áo Nike - 500K x 2 = 1,000K   ?
? Email: ...        ?  2. Qu?n Adidas - 300K x 1 = 300K  ?
? S?T: ...          ?                                     ?
?                   ?  T?m tính: 1,300,000 VN?           ?
? TÓM T?T           ?  Phí ship:   30,000 VN?            ?
? - S? SP: 2        ?  ????????????????????               ?
? - T?ng món: 3     ?  T?ng:    1,330,000 VN?            ?
? - T?ng: 1,330K    ?                                     ?
?                   ?                                     ?
? [Ti?n Hành TT] ? ?                                     ?
???????????????????????????????????????????????????????????
```

### Cart/Checkout.cshtml

```
???????????????????????????????????????????????????????????
? THÔNG TIN KHÁCH HÀNG                                    ?
? Tên: Nguy?n A    |  S?T: 0901234567                     ?
? Email: ...       |  ??a ch?: 123 ABC, TP.HCM           ?
???????????????????????????????????????????????????????????
? S?N PH?M TRONG GI?                                      ?
? ?????????????????????????????????????????????????????   ?
? ? SP           ? SL  ? ??n Giá  ? Thành Ti?n      ?   ?
? ?????????????????????????????????????????????????????   ?
? ? Áo Nike      ?  2  ? 500,000  ? 1,000,000 VN?  ?   ?
? ? Qu?n Adidas  ?  1  ? 300,000  ?   300,000 VN?  ?   ?
? ?????????????????????????????????????????????????????   ?
? ?              T?m tính:         ? 1,300,000 VN?  ?   ?
? ?              Phí v?n chuy?n:   ?    30,000 VN?  ?   ?
? ?              T?NG C?NG:        ? 1,330,000 VN?  ?   ?
? ?????????????????????????????????????????????????????   ?
???????????????????????????????????????????????????????????
???????????????????????????????????????????????????????????
? THÔNG TIN THANH TOÁN                                    ?
?                                                         ?
? Ph??ng th?c: [?? Ti?n M?t        ?]                    ?
?                                                         ?
? ??a ch? giao:  [123 ABC, TP.HCM________________]       ?
?                                                         ?
? Ghi chú:       [_____________________________]          ?
?                                                         ?
? ????????????????????????????????????????????           ?
? ? ?? Thông Tin ??n Hàng:                    ?           ?
? ? - Mã gi?: #123                           ?           ?
? ? - S? s?n ph?m: 2                         ?           ?
? ? - Tóng ti?n: 1,330,000 VN?               ?           ?
? ????????????????????????????????????????????           ?
?                                                         ?
? ????????????????????????????????????????????           ?
? ? ?? Ngày: 24/11/2025                       ?           ?
? ? ?? Gi?: 14:30:25                          ?           ?
? ????????????????????????????????????????????           ?
?                                                         ?
?      [? Xác Nh?n ??t Hàng]                            ?
?      [? Quay L?i Gi? Hàng]                            ?
???????????????????????????????????????????????????????????
```

---

## ?? D? LI?U T? ??NG T?O

### Invoice
```json
{
  "InvoiceId": 1,
  "InvoiceNumber": "INV20251124143025_1234",
  "CustomerId": 3,
  "InvoiceDate": "2025-11-24T14:30:25",
  "TotalAmount": 1330000,
  "PaidAmount": 0,
  "Status": "Pending",
  "Notes": "??n hàng t? gi? hàng #123",
  "CreatedDate": "2025-11-24T14:30:25"
}
```

### InvoiceDetails
```json
[
  {
    "InvoiceDetailId": 1,
    "InvoiceId": 1,
    "ProductId": 1,
    "Quantity": 2,
    "UnitPrice": 500000
  },
  {
    "InvoiceDetailId": 2,
    "InvoiceId": 1,
    "ProductId": 2,
    "Quantity": 1,
    "UnitPrice": 300000
  }
]
```

### Payment
```json
{
  "PaymentId": 1,
  "InvoiceId": 1,
  "Amount": 0,
  "PaymentMethod": "Cash",
  "Status": "Pending",
  "PaymentDate": "2025-11-24T14:30:25",
  "Notes": "Ph??ng th?c thanh toán: Ti?n M?t",
  "CreatedDate": "2025-11-24T14:30:25"
}
```

---

## ?? TESTING

### Các B??c Test

1. **T?o gi? hàng:**
   ```
   POST /Cart/Create
   ? CustomerId = 3
   ```

2. **Thêm s?n ph?m vào gi?:**
   ```
   POST /CartItem/Create
   ? CartId = 1
   ? ProductId = 1, Quantity = 2
   ```

3. **Xem chi ti?t gi?:**
   ```
   GET /Cart/Details/1
   ? Th?y nút "Thanh Toán Ngay"
   ```

4. **Vào trang thanh toán:**
   ```
   GET /Cart/Checkout/1
   ? Th?y form thanh toán
   ? Th?y ngày gi? hi?n t?i
   ```

5. **??t hàng:**
   ```
   POST /Cart/ProcessCheckout
   ? cartId = 1
   ? paymentMethod = "Cash"
   ? shippingAddress = "123 ABC"
   ? notes = "Giao gi? hành chính"
   ```

6. **K?t qu?:**
   ```
   ? Invoice ???c t?o
   ? InvoiceDetails ???c t?o
   ? Payment ???c t?o
   ? Stock ???c c?p nh?t
   ? Cart b? xóa
   ? Redirect ??n Invoice/Details
   ```

---

## ?? C?U HÌNH

### Phí V?n Chuy?n
**Hi?n t?i:** C? ??nh 30,000 VN?  
**S?a ?:** `CartController.cs` ? `Checkout()` action
```csharp
ViewBag.ShippingFee = 30000m; // Thay ??i ? ?ây
```

### Mã Hóa ??n
**Format:** `INV{yyyyMMddHHmmss}{random}`  
**Ví d?:** `INV20251124143025_1234`  
**S?a ?:** `CartController.cs` ? `GenerateInvoiceNumber()`

---

## ?? TRI?N KHAI

### 1. Build Project
```bash
dotnet build
```

### 2. Run Migrations (N?u C?n)
```bash
dotnet ef database update
```

### 3. Ch?y ?ng D?ng
```bash
dotnet run
```

### 4. Test Th? Công
```
1. Vào http://localhost:5000/Cart/Details/1
2. B?m "Thanh Toán Ngay"
3. Ch?n ph??ng th?c thanh toán
4. B?m "Xác Nh?n ??t Hàng"
5. Ki?m tra hóa ??n ???c t?o
```

---

## ?? GHI CHÚ

### Ph??ng Th?c Thanh Toán
- **Cash** (??): Ti?n m?t khi nh?n hàng (COD)
- **BankTransfer** (??): Chuy?n kho?n ngân hàng
- **CreditCard** (??): Th? tín d?ng
- **MobilePayment** (??): Ví ?i?n t? (Momo/ZaloPay)

### Tr?ng Thái
- **Invoice.Status = "Pending"**: Ch? xác nh?n
- **Payment.Status = "Pending"**: Ch?a thanh toán

### Logic Nghi?p V?
1. Khi t?o ??n, `Invoice.PaidAmount = 0` (ch?a thanh toán)
2. Khi thanh toán, c?p nh?t `Payment.Amount` và `Invoice.PaidAmount`
3. N?u `PaidAmount >= TotalAmount`, ??i `Invoice.Status = "Completed"`

---

## ? HOÀN THÀNH

**Ngày hoàn thành:** 2025-11-24  
**Version:** 1.0  
**Tr?ng thái:** ? S?N SÀNG S? D?NG

**Các tính n?ng ?ã implement:**
- ? T? ??ng sinh hóa ??n
- ? Hi?n th? ph??ng th?c thanh toán
- ? Hi?n th? ngày và gi?
- ? C?p nh?t t?n kho
- ? Xóa gi? hàng sau khi ??t
- ? Transaction safety

**Next Steps:**
1. Thêm email notification khi ??t hàng
2. Thêm SMS notification
3. Tích h?p payment gateway
4. Thêm tracking ??n hàng

---

**Tác gi?:** AI Assistant  
**Liên h?:** GitHub Copilot

